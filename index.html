<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÈùôÈü≥„Ç´„É°„É© Pro</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            color: white;
        }

        #camera-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        #canvas {
            display: none;
        }

        /* UI Overlay */
        .controls {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 30px 20px;
            padding-bottom: calc(40px + var(--safe-bottom));
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
        }

        .btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.3);
        }

        #capture-btn {
            width: 85px;
            height: 85px;
            background: white;
            border: 6px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #capture-btn .inner-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #000;
        }

        #capture-btn:active {
            background: #ccc;
        }

        .btn-icon {
            font-size: 24px;
        }

        /* Thumbnail Area */
        .thumbnail-container {
            position: absolute;
            bottom: calc(130px + var(--safe-bottom));
            left: 20px;
            width: 64px;
            height: 64px;
            border-radius: 12px;
            border: 2px solid white;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 11;
            background: #222;
            display: none;
            transition: transform 0.2s;
        }

        .thumbnail-container:active {
            transform: scale(0.95);
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modals */
        #preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #preview-modal.active {
            display: flex;
        }

        #preview-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .modal-header {
            position: absolute;
            top: var(--safe-top);
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .action-bar {
            position: absolute;
            bottom: var(--safe-bottom);
            width: 100%;
            padding: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .action-btn {
            background: white;
            border: none;
            color: black;
            padding: 16px 32px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            max-width: 200px;
            text-align: center;
            text-decoration: none;
        }

        /* Status Messages */
        #status-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 20px;
            z-index: 3000;
            display: none;
            text-align: center;
            font-size: 14px;
            pointer-events: none;
        }

        /* Flash Effect */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .flash-anim {
            animation: flash-frames 0.25s ease-out;
        }

        @keyframes flash-frames {
            0% { opacity: 0; }
            40% { opacity: 0.7; }
            100% { opacity: 0; }
        }

        /* Permission Prompt */
        #permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }

        #permission-screen h2 { margin-bottom: 20px; }
        #permission-screen p { margin-bottom: 30px; color: #aaa; }
    </style>
</head>
<body>

    <div id="permission-screen">
        <h2>„Ç´„É°„É©„ÅÆ‰ΩøÁî®Ë®±ÂèØ</h2>
        <p>ÈùôÈü≥„Ç´„É°„É©„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅ„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</p>
        <button class="action-btn" id="init-camera-btn">„Ç´„É°„É©„ÇíËµ∑Âãï„Åô„Çã</button>
    </div>

    <div id="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>

        <div class="thumbnail-container" id="thumbnail">
            <img id="thumbnail-img" src="" alt="Latest Photo">
        </div>

        <div class="controls">
            <div id="flip-btn" class="btn" title="„Ç´„É°„É©Âàá„ÇäÊõø„Åà">
                <span class="btn-icon">üîÑ</span>
            </div>
            
            <div id="capture-btn" class="btn">
                <div class="inner-circle"></div>
            </div>
            
            <div id="gallery-btn" class="btn" title="ÊúÄËøë„ÅÆÂÜôÁúü">
                <span class="btn-icon">üñºÔ∏è</span>
            </div>
        </div>
    </div>

    <div class="flash-overlay" id="flash"></div>

    <div id="preview-modal">
        <div class="modal-header">
            <button class="close-btn" id="close-preview">‚úï</button>
        </div>
        <img id="preview-image" src="" alt="Captured">
        <div class="action-bar">
            <button class="action-btn" id="share-btn">ÂÖ±Êúâ„Éª‰øùÂ≠ò</button>
            <button class="action-btn" id="download-btn" style="background: #333; color: white;">‰øùÂ≠ò</button>
        </div>
    </div>

    <div id="status-msg"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const flipBtn = document.getElementById('flip-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        const thumbnail = document.getElementById('thumbnail');
        const thumbnailImg = document.getElementById('thumbnail-img');
        const previewModal = document.getElementById('preview-modal');
        const previewImage = document.getElementById('preview-image');
        const closePreview = document.getElementById('close-preview');
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const flash = document.getElementById('flash');
        const statusMsg = document.getElementById('status-msg');
        const permissionScreen = document.getElementById('permission-screen');
        const initBtn = document.getElementById('init-camera-btn');

        let currentStream = null;
        let facingMode = 'environment';
        let photos = [];

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showStatus(text, duration = 2000) {
            statusMsg.innerHTML = text;
            statusMsg.style.display = 'block';
            setTimeout(() => {
                statusMsg.style.display = 'none';
            }, duration);
        }

        // „Ç´„É°„É©Ëµ∑Âãï
        async function startCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 4096 }, // È´òËß£ÂÉèÂ∫¶„ÇíË©¶Ë°å
                        height: { ideal: 2160 }
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                permissionScreen.style.display = 'none';
                
                // „Éì„Éá„Ç™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü
                await video.play();
            } catch (error) {
                console.error('Camera Error:', error);
                showStatus('„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ<br>„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 5000);
            }
        }

        // ÊíÆÂΩ±Âá¶ÁêÜ
        function capturePhoto() {
            if (!video.videoWidth) return;

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Â∑¶Âè≥ÂèçËª¢„ÅÆÂØæÂøúÔºà„Ç§„É≥„Ç´„É°„É©„ÅÆÂ†¥ÂêàÔºâ
            if (facingMode === 'user') {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }

            // „Éï„É©„ÉÉ„Ç∑„É•ÊºîÂá∫
            flash.classList.remove('flash-anim');
            void flash.offsetWidth; // reflow
            flash.classList.add('flash-anim');

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            
            canvas.toBlob((blob) => {
                const photoObj = {
                    url: dataUrl,
                    blob: blob,
                    id: Date.now()
                };
                photos.push(photoObj);
                
                // „Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞
                thumbnailImg.src = dataUrl;
                thumbnail.style.display = 'block';
                
                // Ëß¶Ë¶ö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
                if (window.navigator.vibrate) {
                    window.navigator.vibrate(50);
                }
            }, 'image/jpeg', 0.9);
        }

        // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function openPreview(url) {
            previewImage.src = url || photos[photos.length - 1]?.url;
            if (previewImage.src) {
                previewModal.classList.add('active');
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        initBtn.addEventListener('click', startCamera);

        captureBtn.addEventListener('click', capturePhoto);

        flipBtn.addEventListener('click', () => {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            startCamera();
        });

        thumbnail.addEventListener('click', () => openPreview());
        galleryBtn.addEventListener('click', () => {
            if (photos.length > 0) openPreview();
            else showStatus('„Åæ„Å†ÂÜôÁúü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        });

        closePreview.addEventListener('click', () => {
            previewModal.classList.remove('active');
        });

        // ‰øùÂ≠òÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºâ
        downloadBtn.addEventListener('click', () => {
            const currentPhoto = photos.find(p => p.url === previewImage.src) || photos[photos.length - 1];
            if (!currentPhoto) return;

            const link = document.createElement('a');
            link.href = currentPhoto.url;
            link.download = `camera_shot_${currentPhoto.id}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        });

        // ÂÖ±Êúâ
        shareBtn.addEventListener('click', async () => {
            const currentPhoto = photos.find(p => p.url === previewImage.src) || photos[photos.length - 1];
            if (!currentPhoto) return;

            try {
                if (navigator.share && navigator.canShare) {
                    const file = new File([currentPhoto.blob], 'photo.jpg', { type: 'image/jpeg' });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'ÂÜôÁúü„ÅÆÂÖ±Êúâ',
                        });
                    } else {
                        throw new Error('Share not supported');
                    }
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    downloadBtn.click();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showStatus('ÂÖ±Êúâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
        });

        // „Éö„Éº„Ç∏ÂèØË¶ñÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÊôÇ„Å´„Ç´„É°„É©ÂÅúÊ≠¢Ôºâ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
            } else {
                if (permissionScreen.style.display === 'none') {
                    startCamera();
                }
            }
        });

    </script>
</body>
</html>
